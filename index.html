
<!doctype html>
<html lang="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SubstantivSpill â€“ sorter substantiv</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<style>
  :root{
    --bg1:#0f1020; --bg2:#1a0933; --ink:#f7f7fb; --muted:#c7c7d7;
    --accent:#7c5cff; --accent2:#00e0a4; --bad:#ff5c7a; --warn:#ffd166;
    --card:#141429; --glass:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.35);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink);
    background:
      radial-gradient(1200px 800px at 20% 10%, #2a1768 0, transparent 60%),
      radial-gradient(1200px 800px at 80% 90%, #0f805a 0, transparent 60%),
      linear-gradient(120deg,var(--bg1),var(--bg2));
    overflow-x:hidden;
  }
  .blob{position:fixed; pointer-events:none; filter:blur(30px); opacity:.5; z-index:0}
  .b1{width:240px;height:240px;background:#7c5cff;top:10%;left:5%;border-radius:50% 40% 60% 50%}
  .b2{width:280px;height:280px;background:#00e0a4;bottom:8%;right:6%;border-radius:50% 60% 45% 55%}
  @keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-12px)}100%{transform:translateY(0)}}
  .blob{animation:floaty 7s ease-in-out infinite}

  .wrap{position:relative;z-index:1;max-width:1150px;margin:0 auto;padding:28px 16px 48px}
  header{display:flex;align-items:center;gap:14px;margin-bottom:16px}
  .logo{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,#7c5cff,#00e0a4);display:grid;place-items:center;box-shadow:var(--shadow)}
  .logo svg{width:28px;height:28px;fill:white}
  h1{margin:0;font-size:clamp(22px,3.2vw,34px)}
  .subtitle{color:var(--muted);font-size:14px;margin-top:4px}

  .panel{background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.06));
         border:1px solid rgba(255,255,255,.12); box-shadow:var(--shadow); border-radius:var(--radius); padding:16px}

  .controls{display:grid;grid-template-columns:1.2fr 1fr;gap:14px;align-items:start;margin-bottom:14px}
  @media (max-width:980px){.controls{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:var(--radius);padding:14px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .chip{border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);padding:8px 12px;border-radius:999px;
        cursor:pointer;user-select:none;font-size:14px;transition:.15s}
  .chip input{display:none}
  .chip.active{border-color:var(--accent2);background:rgba(0,224,164,.14)}
  .btn{background:linear-gradient(135deg,var(--accent),#5f40ff);color:#fff;border:none;padding:12px 16px;border-radius:12px;
       font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(124,92,255,.35)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.18)}
  .btn.alt{background:linear-gradient(135deg,var(--accent2),#02c38c)}
  .note{color:var(--muted);font-size:12px}

  .game{display:grid;grid-template-columns:1fr 320px;gap:14px}
  @media (max-width:1010px){.game{grid-template-columns:1fr}}

  .statusbar{display:flex;justify-content:space-between;align-items:center;gap:10px;color:var(--muted);font-size:14px;margin-bottom:8px}
  .progress{flex:1;height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
  .progress>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent2),var(--accent));transition:width .5s ease}
  .pill{border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);border-radius:14px;padding:10px;text-align:center}
  .big{font-size:22px;font-weight:800}
  .muted{color:var(--muted)}

  .board{display:grid;grid-template-columns:1fr;gap:12px}
  .bins{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .bins.three{grid-template-columns:repeat(3,1fr)}
  .bins.four{grid-template-columns:repeat(4,1fr)}
  .bin{background:rgba(255,255,255,.06);border:1px dashed rgba(255,255,255,.22);border-radius:14px;padding:10px;min-height:140px}
  .binHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .binTitle{font-weight:800;letter-spacing:.4px}
  .binCount{color:var(--muted);font-size:12px}

  .pool{display:flex;flex-wrap:wrap;gap:8px;min-height:52px}
  .tile{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:8px 10px;
        cursor:grab;user-select:none;transition:.12s;font-weight:700}
  .tile:active{cursor:grabbing}
  .tile.correct{background:rgba(0,224,164,.18);border-color:var(--accent2)}
  .tile.wrong{background:rgba(255,92,122,.18);border-color:var(--bad)}
  .tile.selected{outline:2px solid var(--accent); box-shadow:0 0 0 2px rgba(124,92,255,.35) inset}
  .bin.dropTarget{background:rgba(255,255,255,.10);border-color:var(--accent2)}
  .hint{font-size:14px}
  .feedback{margin-top:8px;border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,.16);
            background:rgba(255,255,255,.06);display:none}
  .feedback.good{display:block;border-color:var(--accent2);background:rgba(0,224,164,.14)}
  .feedback.bad{display:block;border-color:var(--bad);background:rgba(255,92,122,.14)}
  .footer{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between}

  /* Konfetti */
  canvas#confetti{position:fixed;inset:0;pointer-events:none;z-index:5}

  /* Modal for egne ord */
  .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:10}
  .modal{background:var(--card);border:1px solid rgba(255,255,255,.18);border-radius:14px;max-width:620px;width:92%;
          box-shadow:var(--shadow);padding:14px}
  .modal h3{margin:0 0 8px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:13px;color:var(--muted)}
  .field input, .field select{
    padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.06);color:#fff;outline:none
  }
  .tagbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .tag{border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:6px 10px;cursor:pointer}
  .tag.active{border-color:var(--accent2);background:rgba(0,224,164,.14)}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="blob b1"></div><div class="blob b2"></div>

<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M12 2c5.52 0 10 4.48 10 10h-2a8 8 0 1 0-4.68 7.28l.93 1.78A10 10 0 1 1 12 2Zm5.5 6.5a1.5 1.5 0 0 1 0 3H13v7a1.5 1.5 0 0 1-3 0V9.5c0-.83.67-1.5 1.5-1.5h6Z"/></svg>
    </div>
    <div>
      <h1>SubstantivSpill âš¡ â€“ sorter riktig</h1>
      <div class="subtitle">Dra ord til riktig kategori â€“ eller klikk pÃ¥ et ord og sÃ¥ pÃ¥ en boks.</div>
    </div>
  </header>

  <section class="panel">
    <div class="controls">
      <div class="card">
        <h3>Velg modul og tema</h3>
        <div class="row" id="modeRow">
          <label class="chip active"><input type="radio" name="mode" value="entall-flertall" checked> Entall / Flertall</label>
          <label class="chip"><input type="radio" name="mode" value="ubestemt-bestemt"> Ubestemt / Bestemt</label>
          <label class="chip"><input type="radio" name="mode" value="felles-egennavn"> Fellesnavn / Egennavn</label>
          <label class="chip"><input type="radio" name="mode" value="kjonn"> KjÃ¸nn: en / ei / et</label>
          <label class="chip"><input type="radio" name="mode" value="fire-bokser"> 4â€‘bokser (entall/ub, entall/b, flertall/ub, flertall/b)</label>
        </div>

        <div style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Tema (velg ett eller flere):</div>
          <div class="row" id="themeRow">
            <label class="chip active"><input type="checkbox" value="skole" checked> Skole</label>
            <label class="chip active"><input type="checkbox" value="butikk" checked> Butikk</label>
            <label class="chip active"><input type="checkbox" value="helse" checked> Helse</label>
            <label class="chip active"><input type="checkbox" value="fritid" checked> Fritid</label>
            <label class="chip active"><input type="checkbox" value="hjem" checked> Hjem</label>
            <label class="chip active"><input type="checkbox" value="teknologi" checked> Teknologi</label>
            <label class="chip active"><input type="checkbox" value="familie" checked> Familie</label>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <label class="chip active" id="easy"><input type="radio" name="diff" value="8" checked> Lett (8 ord)</label>
          <label class="chip" id="hard"><input type="radio" name="diff" value="12"> Vanskelig (12 ord)</label>
          <label class="chip" id="clickMode"><input type="checkbox" id="clickOnly"> Klikk i stedet for Ã¥ dra</label>
          <button class="chip" id="addWordBtn" style="font-weight:700">âž• Legg til egne ord</button>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn alt" id="startBtn">Start â–¶</button>
          <button class="btn ghost" id="resetBtn">Tilbakestill poeng</button>
        </div>
        <div class="note" style="margin-top:6px">Beste poengsum lagres i nettleseren.</div>
      </div>

      <div class="card">
        <h3>Statistikk</h3>
        <div class="row" style="gap:10px">
          <div class="pill"><div class="muted">Oppgave</div><div class="big" id="qNum">0</div></div>
          <div class="pill"><div class="muted">Poeng</div><div class="big" id="score">0</div></div>
          <div class="pill"><div class="muted">Streak</div><div class="big" id="streak">0</div></div>
          <div class="pill"><div class="muted">Beste</div><div class="big" id="best">0</div></div>
        </div>
        <div class="statusbar" style="margin-top:10px">
          <div class="progress" aria-hidden="true"><span id="prog"></span></div>
        </div>
        <div class="note">Tips: Klikk Â«HintÂ» under for regler og eksempler.</div>
      </div>
    </div>

    <div class="game">
      <div class="card">
        <div class="statusbar">
          <div><span class="muted">Modus</span> <strong id="modeTitle">â€“</strong></div>
          <div><span class="muted">Runde</span> <strong id="roundInfo">â€“</strong></div>
        </div>

        <div class="board">
          <div class="pool" id="pool" aria-label="Ord som skal sorteres"></div>
          <div id="bins" class="bins"></div>
        </div>

        <div id="feedback" class="feedback" aria-live="polite"></div>

        <div class="footer">
          <div class="row">
            <button class="btn ghost" id="hintBtn">ðŸ’¡ Hint</button>
            <button class="btn ghost" id="shuffleBtn">ðŸ”„ Bland ord</button>
          </div>
          <div class="row">
            <button class="btn" id="nextBtn" disabled>Neste runde âžœ</button>
          </div>
        </div>
      </div>

      <aside class="card hint">
        <strong>Regler i korte trekk</strong>
        <ul style="margin-top:8px">
          <li><b>Entall</b> = Ã©n / ett. <b>Flertall</b> = flere.</li>
          <li><b>Ubestemt</b>: ny informasjon (f.eks. <i>en stol, stoler</i>). <b>Bestemt</b>: noe kjent (f.eks. <i>stolen, stolene</i>).</li>
          <li><b>Fellesnavn</b> (vanlige ting/ord) vs. <b>Egennavn</b> (navn pÃ¥ personer, steder, merker).</li>
          <li><b>KjÃ¸nn</b>: <b>en-ord</b>, <b>ei-ord</b>, <b>et-ord</b>. (Mange sier ogsÃ¥ <i>en bok</i> â€“ her bruker vi skolebÃ¸yning.)</li>
        </ul>
        <div class="note">Du kan dra med musen, eller klikke pÃ¥ et ord og deretter pÃ¥ en boks.</div>
      </aside>
    </div>
  </section>
</div>

<!-- Modal for egne ord -->
<div class="modalBackdrop" id="modal">
  <div class="modal">
    <h3>Legg til eget substantiv</h3>
    <div class="grid3">
      <div class="field"><label>Base (infinitivform)</label><input id="mBase" placeholder="f.eks. stol"></div>
      <div class="field"><label>KjÃ¸nn</label>
        <select id="mGender">
          <option value="en">en</option>
          <option value="ei">ei</option>
          <option value="et">et</option>
        </select>
      </div>
      <div class="field"><label>Type</label>
        <select id="mType">
          <option value="fellesnavn" selected>Fellesnavn</option>
          <option value="egennavn">Egennavn</option>
        </select>
      </div>
    </div>
    <div class="grid2" style="margin-top:8px">
      <div class="field"><label>Entall ubestemt</label><input id="mSgInd" placeholder="stol"></div>
      <div class="field"><label>Entall bestemt</label><input id="mSgDef" placeholder="stolen"></div>
      <div class="field"><label>Flertall ubestemt</label><input id="mPlInd" placeholder="stoler"></div>
      <div class="field"><label>Flertall bestemt</label><input id="mPlDef" placeholder="stolene"></div>
    </div>

    <div class="field" style="margin-top:8px">
      <label>Tema (velg Ã©n eller flere)</label>
      <div class="tagbar" id="mThemes">
        <div class="tag" data-v="skole">Skole</div>
        <div class="tag" data-v="butikk">Butikk</div>
        <div class="tag" data-v="helse">Helse</div>
        <div class="tag" data-v="fritid">Fritid</div>
        <div class="tag" data-v="hjem">Hjem</div>
        <div class="tag" data-v="teknologi">Teknologi</div>
        <div class="tag" data-v="familie">Familie</div>
      </div>
    </div>

    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button class="btn ghost" id="mCancel">Avbryt</button>
      <button class="btn" id="mSave">Lagre âž•</button>
    </div>
    <div class="note" style="margin-top:8px">Tips: Feltene fylles automatisk nÃ¥r du skriver Â«BaseÂ» + Â«KjÃ¸nnÂ», men kan endres.</div>
  </div>
</div>

<script>
/** ---------- DATA ---------- **/
const NOUNS = [
  {base:"stol", gender:"en", forms:{sgInd:"stol", sgDef:"stolen", plInd:"stoler", plDef:"stolene"}, type:"fellesnavn", themes:["hjem","skole","butikk"]},
  {base:"bok", gender:"ei", forms:{sgInd:"bok", sgDef:"boka", plInd:"bÃ¸ker", plDef:"bÃ¸kene"}, type:"fellesnavn", themes:["skole","fritid"]},
  {base:"hus", gender:"et", forms:{sgInd:"hus", sgDef:"huset", plInd:"hus", plDef:"husene"}, type:"fellesnavn", themes:["hjem"]},
  {base:"barn", gender:"et", forms:{sgInd:"barn", sgDef:"barnet", plInd:"barn", plDef:"barna"}, type:"fellesnavn", themes:["familie","fritid"]},
  {base:"katt", gender:"en", forms:{sgInd:"katt", sgDef:"katten", plInd:"katter", plDef:"kattene"}, type:"fellesnavn", themes:["hjem","fritid"]},
  {base:"dÃ¸r", gender:"ei", forms:{sgInd:"dÃ¸r", sgDef:"dÃ¸ra", plInd:"dÃ¸rer", plDef:"dÃ¸rene"}, type:"fellesnavn", themes:["hjem","skole"]},
  {base:"jente", gender:"ei", forms:{sgInd:"jente", sgDef:"jenta", plInd:"jenter", plDef:"jentene"}, type:"fellesnavn", themes:["skole","fritid"]},
  {base:"gutt", gender:"en", forms:{sgInd:"gutt", sgDef:"gutten", plInd:"gutter", plDef:"guttene"}, type:"fellesnavn", themes:["skole","fritid"]},
  {base:"eple", gender:"et", forms:{sgInd:"eple", sgDef:"eplet", plInd:"epler", plDef:"eplene"}, type:"fellesnavn", themes:["helse","butikk","hjem"]},
  {base:"sprÃ¥k", gender:"et", forms:{sgInd:"sprÃ¥k", sgDef:"sprÃ¥ket", plInd:"sprÃ¥k", plDef:"sprÃ¥kene"}, type:"fellesnavn", themes:["skole"]},
  {base:"venn", gender:"en", forms:{sgInd:"venn", sgDef:"vennen", plInd:"venner", plDef:"vennene"}, type:"fellesnavn", themes:["fritid","skole"]},
  {base:"nabo", gender:"en", forms:{sgInd:"nabo", sgDef:"naboen", plInd:"naboer", plDef:"naboene"}, type:"fellesnavn", themes:["hjem"]},
  {base:"familie", gender:"en", forms:{sgInd:"familie", sgDef:"familien", plInd:"familier", plDef:"familiene"}, type:"fellesnavn", themes:["familie"]},
  {base:"skole", gender:"en", forms:{sgInd:"skole", sgDef:"skolen", plInd:"skoler", plDef:"skolene"}, type:"fellesnavn", themes:["skole"]},
  {base:"lÃ¦rer", gender:"en", forms:{sgInd:"lÃ¦rer", sgDef:"lÃ¦reren", plInd:"lÃ¦rere", plDef:"lÃ¦rerne"}, type:"fellesnavn", themes:["skole"]},
  {base:"elev", gender:"en", forms:{sgInd:"elev", sgDef:"eleven", plInd:"elever", plDef:"elevene"}, type:"fellesnavn", themes:["skole"]},
  {base:"by", gender:"en", forms:{sgInd:"by", sgDef:"byen", plInd:"byer", plDef:"byene"}, type:"fellesnavn", themes:["fritid"]},
  {base:"mobil", gender:"en", forms:{sgInd:"mobil", sgDef:"mobilen", plInd:"mobiler", plDef:"mobilene"}, type:"fellesnavn", themes:["teknologi","fritid","skole"]},
  {base:"klokke", gender:"ei", forms:{sgInd:"klokke", sgDef:"klokka", plInd:"klokker", plDef:"klokkene"}, type:"fellesnavn", themes:["hjem","fritid"]},
  {base:"kopp", gender:"en", forms:{sgInd:"kopp", sgDef:"koppen", plInd:"kopper", plDef:"koppene"}, type:"fellesnavn", themes:["hjem","skole"]},
  {base:"butikk", gender:"en", forms:{sgInd:"butikk", sgDef:"butikken", plInd:"butikker", plDef:"butikkene"}, type:"fellesnavn", themes:["butikk"]},
  {base:"kunde", gender:"en", forms:{sgInd:"kunde", sgDef:"kunden", plInd:"kunder", plDef:"kundene"}, type:"fellesnavn", themes:["butikk"]},
  {base:"lege", gender:"en", forms:{sgInd:"lege", sgDef:"legen", plInd:"leger", plDef:"legene"}, type:"fellesnavn", themes:["helse"]},
  {base:"sykehus", gender:"et", forms:{sgInd:"sykehus", sgDef:"sykehuset", plInd:"sykehus", plDef:"sykehusene"}, type:"fellesnavn", themes:["helse"]},
  {base:"medisin", gender:"en", forms:{sgInd:"medisin", sgDef:"medisinen", plInd:"medisiner", plDef:"medisinene"}, type:"fellesnavn", themes:["helse","butikk"]},
  {base:"ost", gender:"en", forms:{sgInd:"ost", sgDef:"osten", plInd:"oster", plDef:"ostene"}, type:"fellesnavn", themes:["butikk","hjem"]},
  {base:"brÃ¸d", gender:"et", forms:{sgInd:"brÃ¸d", sgDef:"brÃ¸det", plInd:"brÃ¸d", plDef:"brÃ¸dene"}, type:"fellesnavn", themes:["butikk","hjem"]},
  {base:"apotek", gender:"et", forms:{sgInd:"apotek", sgDef:"apoteket", plInd:"apotek", plDef:"apotekene"}, type:"fellesnavn", themes:["helse","butikk"]},
];

const PROPER_BY_THEME = {
  skole: ["NTNU","OsloMet","HÃ¸gskolen","Kuben"],
  butikk: ["IKEA","Rema 1000","Kiwi"],
  helse: ["Ahus","Sykehuset Innlandet"],
  fritid: ["GjÃ¸vik","Oslo","Norge","Toten"],
  hjem: ["GjÃ¸vik","Norge"],
  teknologi: ["Google","Apple","Microsoft"],
  familie: ["Ali","Ahmed","Sara","Maria","Jon","Eli"]
};

/** ---------- STATE ---------- **/
const byId = id => document.getElementById(id);
const rand = arr => arr[Math.floor(Math.random()*arr.length)];
const shuffle = arr => arr.sort(()=>Math.random()-0.5);

let state = {
  mode: "entall-flertall",
  size: 8,
  qNum: 0,
  placed: 0,
  score: 0,
  streak: 0,
  best: Number(localStorage.getItem("nounBest") || 0),
  selectedThemes: ["skole","butikk","helse","fritid","hjem","teknologi","familie"],
  currentItems: [], // {id, text, tags:{number,def,gender,type}}
  selectedTileId: null
};

/** ---------- HELPERS ---------- **/
function setMode(val){
  state.mode = val;
  const titleMap = {
    "entall-flertall": "ENTALL / FLERTALL",
    "ubestemt-bestemt": "UBESTEMT / BESTEMT",
    "felles-egennavn": "FELLESNAVN / EGENNAVN",
    "kjonn": "KJÃ˜NN: en / ei / et",
    "fire-bokser": "4â€‘BOKSER (entall/ub, entall/b, flertall/ub, flertall/b)"
  };
  byId("modeTitle").textContent = titleMap[val] || "â€“";
}

function updateHUD(){
  byId("qNum").textContent = state.qNum;
  byId("score").textContent = state.score;
  byId("streak").textContent = state.streak;
  byId("best").textContent = state.best;
  byId("roundInfo").textContent = state.placed + " / " + state.currentItems.length;
  const pct = state.currentItems.length ? Math.round(100*state.placed/state.currentItems.length) : 0;
  byId("prog").style.width = pct + "%";
}

function nounsByThemes(){
  const sel = state.selectedThemes;
  const list = NOUNS.filter(n => n.themes.some(t => sel.includes(t)));
  return list.length ? list : NOUNS; // fallback hvis tomt
}

function properByThemes(count){
  const sel = state.selectedThemes;
  let pool = [];
  sel.forEach(t => pool = pool.concat(PROPER_BY_THEME[t] || []));
  if(pool.length===0) pool = ["Oslo","Norge","Ali","Sara"];
  pool = Array.from(new Set(pool));
  return shuffle(pool).slice(0, count);
}

function tokenizeForMode(){
  const items = [];
  const size = state.size;

  if(state.mode === "felles-egennavn"){
    const commons = shuffle([...nounsByThemes()]).slice(0, Math.ceil(size/2));
    const propers = properByThemes(size - commons.length);
    commons.forEach((n,i)=>{
      items.push({ id: "c"+i, text: n.forms.sgInd, tags:{type:"fellesnavn"} });
    });
    propers.forEach((p,i)=>{
      items.push({ id: "p"+i, text: p, tags:{type:"egennavn"} });
    });
  }
  else if(state.mode === "kjonn"){
    const pick = shuffle([...nounsByThemes()]).slice(0, size);
    pick.forEach((n,i)=>{
      items.push({ id:"g"+i, text: n.forms.sgInd, tags:{gender:n.gender} });
    });
  }
  else {
    // entall/flertall, ubestemt/bestemt og 4-bokser bruker bÃ¸yningsformer
    const forms = [];
    nounsByThemes().forEach(n=>{
      forms.push({text:n.forms.sgInd,  number:"entall", def:"ubestemt"});
      forms.push({text:n.forms.sgDef,  number:"entall", def:"bestemt"});
      forms.push({text:n.forms.plInd,  number:"flertall", def:"ubestemt"});
      forms.push({text:n.forms.plDef,  number:"flertall", def:"bestemt"});
    });
    const sample = shuffle(forms).slice(0, size);
    sample.forEach((f,i)=> items.push({id:"f"+i, text:f.text, tags:{number:f.number, def:f.def}}));
  }

  return shuffle(items);
}

function binsForMode(){
  if(state.mode==="entall-flertall"){
    return [
      {key:"entall", title:"ENTALL"},
      {key:"flertall", title:"FLERTALL"},
    ];
  }
  if(state.mode==="ubestemt-bestemt"){
    return [
      {key:"ubestemt", title:"UBESTEMT"},
      {key:"bestemt", title:"BESTEMT"},
    ];
  }
  if(state.mode==="felles-egennavn"){
    return [
      {key:"fellesnavn", title:"FELLESNAVN"},
      {key:"egennavn", title:"EGENNAVN"},
    ];
  }
  if(state.mode==="kjonn"){
    return [
      {key:"en", title:"EN-ORD"},
      {key:"ei", title:"EI-ORD"},
      {key:"et", title:"ET-ORD"},
    ];
  }
  // fire-bokser
  return [
    {key:"entall-ubestemt",  title:"ENTALL â€¢ UBESTEMT"},
    {key:"entall-bestemt",   title:"ENTALL â€¢ BESTEMT"},
    {key:"flertall-ubestemt",title:"FLERTALL â€¢ UBESTEMT"},
    {key:"flertall-bestemt", title:"FLERTALL â€¢ BESTEMT"},
  ];
}

function isCorrectForBin(item, binKey){
  if(state.mode==="entall-flertall"){
    return item.tags.number === binKey;
  }
  if(state.mode==="ubestemt-bestemt"){
    return item.tags.def === binKey;
  }
  if(state.mode==="felles-egennavn"){
    return item.tags.type === binKey;
  }
  if(state.mode==="kjonn"){
    return item.tags.gender === binKey;
  }
  if(state.mode==="fire-bokser"){
    const mk = (item.tags.number || "") + "-" + (item.tags.def || "");
    return mk === binKey;
  }
  return false;
}

/** ---------- RENDER ---------- **/
function renderBoard(){
  const pool = byId("pool");
  pool.innerHTML = "";
  state.currentItems.forEach(it=>{
    const t = document.createElement("div");
    t.className = "tile";
    t.textContent = it.text;
    t.draggable = !byId("clickOnly").checked;
    t.dataset.id = it.id;
    t.addEventListener("dragstart", onDragStart);
    t.addEventListener("click", onTileClick);
    pool.appendChild(t);
  });

  const binsEl = byId("bins");
  const bins = binsForMode();
  binsEl.className = "bins" + (bins.length===3? " three": bins.length===4? " four" : "");
  binsEl.innerHTML = "";
  bins.forEach(b=>{
    const bin = document.createElement("div");
    bin.className = "bin";
    bin.dataset.key = b.key;
    const header = document.createElement("div");
    header.className = "binHeader";
    const title = document.createElement("div");
    title.className = "binTitle";
    title.textContent = b.title;
    const count = document.createElement("div");
    count.className = "binCount";
    count.textContent = "0";
    header.appendChild(title); header.appendChild(count);
    const slot = document.createElement("div");
    slot.className = "slot";
    bin.appendChild(header); bin.appendChild(slot);

    // DnD
    bin.addEventListener("dragover", e=>{e.preventDefault(); bin.classList.add("dropTarget");});
    bin.addEventListener("dragleave", ()=>bin.classList.remove("dropTarget"));
    bin.addEventListener("drop", e=>{
      e.preventDefault(); bin.classList.remove("dropTarget");
      const id = e.dataTransfer.getData("text/plain");
      placeTileInBin(id, b.key, bin);
    });
    // Klikk-tilordning
    bin.addEventListener("click", ()=>{
      const id = state.selectedTileId;
      if(id) placeTileInBin(id, b.key, bin);
    });

    binsEl.appendChild(bin);
  });

  byId("feedback").style.display="none";
  byId("feedback").className="feedback";
  byId("nextBtn").disabled = true;
}

function onDragStart(e){
  e.dataTransfer.setData("text/plain", e.currentTarget.dataset.id);
}
function onTileClick(e){
  const was = state.selectedTileId;
  const id = e.currentTarget.dataset.id;
  // reset all
  Array.from(document.querySelectorAll(".tile")).forEach(el=>el.classList.remove("selected"));
  if(was===id){ state.selectedTileId=null; return; }
  state.selectedTileId = id;
  e.currentTarget.classList.add("selected");
}

function placeTileInBin(id, binKey, binEl){
  const item = state.currentItems.find(x=>x.id===id);
  if(!item) return;
  const tile = document.querySelector(`.tile[data-id="${id}"]`);
  if(!tile) return;

  const ok = isCorrectForBin(item, binKey);
  tile.classList.remove("selected");
  if(ok){
    tile.classList.add("correct");
    tile.draggable = false;
    state.placed += 1;
    state.score += 10;
    state.streak += 1;
    const slot = binEl.querySelector(".slot");
    slot.appendChild(tile);
    const countEl = binEl.querySelector(".binCount");
    countEl.textContent = String((slot.querySelectorAll(".tile").length)||0);
  }else{
    tile.classList.add("wrong");
    state.streak = 0;
    setTimeout(()=>tile.classList.remove("wrong"), 550);
  }
  state.selectedTileId = null;
  updateHUD();

  if(state.placed === state.currentItems.length){
    roundComplete();
  }
}

function roundComplete(){
  const fb = byId("feedback");
  fb.style.display="block"; fb.className="feedback good";
  fb.innerHTML = `ðŸŽ‰ Flott! Du sorterte alle ordene.<br>Poeng denne runden: <b>${state.currentItems.length*10}</b>`;
  fireConfetti();
  if(state.score > state.best){
    state.best = state.score;
    localStorage.setItem("nounBest", String(state.best));
  }
  byId("nextBtn").disabled = false;
  updateHUD();
}

/** ---------- GAME FLOW ---------- **/
function startRound(){
  state.qNum += 1;
  state.placed = 0;
  state.currentItems = tokenizeForMode();
  renderBoard();
  updateHUD();
}

function startGame(){
  state.score = 0; state.streak=0; state.qNum=0;
  startRound();
}

/** ---------- CONFETTI ---------- **/
const confettiCanvas = document.getElementById("confetti");
const ctx = confettiCanvas.getContext("2d");
let confettiPieces = [];
function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
window.addEventListener("resize", resizeCanvas); resizeCanvas();
function fireConfetti(){
  for(let i=0;i<90;i++){
    confettiPieces.push({
      x: confettiCanvas.width/2, y: confettiCanvas.height/3,
      vx: (Math.random()*4-2)*(1+Math.random()*1.5),
      vy: (Math.random()*-3-2), g: 0.09+Math.random()*0.04,
      s: 4+Math.random()*6, c: (Math.random()<.33?"#7c5cff":(Math.random()<.5?"#00e0a4":"#ffd166")),
      a:1, r:Math.random()*Math.PI
    });
  }
}
(function loop(){
  ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  confettiPieces.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.r+=0.1; p.a-=0.008; });
  confettiPieces = confettiPieces.filter(p=>p.a>0 && p.y<confettiCanvas.height+20);
  confettiPieces.forEach(p=>{
    ctx.globalAlpha=Math.max(0,p.a); ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r);
    ctx.fillStyle=p.c; ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore();
  });
  requestAnimationFrame(loop);
})();

/** ---------- MODAL: EGNE ORD ---------- **/
function openModal(){ byId("modal").style.display="grid"; }
function closeModal(){ byId("modal").style.display="none"; }
function suggestForms(){
  const base = byId("mBase").value.trim();
  const gender = byId("mGender").value;
  if(!base) return;
  // enkle forslag (kan redigeres)
  const sgInd = base;
  const sgDef = (gender==="en"? base+"en" : gender==="ei"? base+"a" : base+"et");
  // naive flertallsforslag (kan vÃ¦re feil for uregelmessige): -er / -ene for de fleste
  let plInd = base + "er";
  let plDef = base + "ene";
  // noen kjente unntak
  const invariants = ["hus","barn","apotek","sprÃ¥k","brÃ¸d"];
  if(invariants.includes(base)){ plInd = base; plDef = (base==="brÃ¸d")? "brÃ¸dene" : base+"ene"; }
  // fyll feltene, men la lÃ¦rer justere manuelt
  byId("mSgInd").value = sgInd;
  byId("mSgDef").value = sgDef;
  byId("mPlInd").value = plInd;
  byId("mPlDef").value = plDef;
}
function collectThemesFromModal(){
  return Array.from(byId("mThemes").querySelectorAll(".tag.active")).map(el=>el.dataset.v);
}
function saveWordFromModal(){
  const base = byId("mBase").value.trim();
  const gender = byId("mGender").value;
  const type = byId("mType").value;
  const sgInd = byId("mSgInd").value.trim();
  const sgDef = byId("mSgDef").value.trim();
  const plInd = byId("mPlInd").value.trim();
  const plDef = byId("mPlDef").value.trim();
  const themes = collectThemesFromModal();
  if(!base || !gender || !sgInd || !sgDef || !plInd || !plDef){
    alert("Fyll inn alle former (entall/flertall, ubestemt/bestemt)."); return;
  }
  // Hvis egennavn: lag som eget element i PROPER_BY_THEME
  if(type==="egennavn"){
    themes.forEach(t=>{
      PROPER_BY_THEME[t] = (PROPER_BY_THEME[t]||[]);
      PROPER_BY_THEME[t].push(base.charAt(0).toUpperCase() + base.slice(1));
      PROPER_BY_THEME[t] = Array.from(new Set(PROPER_BY_THEME[t])); // unik
    });
  } else {
    // Fellesnavn
    NOUNS.push({
      base, gender,
      forms:{sgInd, sgDef, plInd, plDef},
      type:"fellesnavn",
      themes: themes.length? themes : ["fritid"]
    });
  }
  closeModal();
  alert("Lagt til! Du kan starte en ny runde for Ã¥ se ordet.");
}

/** ---------- EVENTS ---------- **/
document.addEventListener("DOMContentLoaded", ()=>{
  // Modus-klikk
  Array.from(document.querySelectorAll("#modeRow .chip")).forEach(label=>{
    label.addEventListener("click", ()=>{
      Array.from(document.querySelectorAll("#modeRow .chip")).forEach(l=>l.classList.remove("active"));
      label.classList.add("active");
      const val = label.querySelector("input").value;
      setMode(val);
    });
  });

  // Tema
  Array.from(document.querySelectorAll("#themeRow .chip")).forEach(chip=>{
    chip.addEventListener("click", ()=>{
      const cb = chip.querySelector("input");
      cb.checked = !cb.checked;
      chip.classList.toggle("active", cb.checked);
      const sel = Array.from(document.querySelectorAll("#themeRow input:checked")).map(i=>i.value);
      state.selectedThemes = sel.length? sel : ["skole"]; // minst ett
    });
  });

  // Vanskelighet
  byId("easy").addEventListener("click", ()=>{
    byId("easy").classList.add("active"); byId("hard").classList.remove("active");
    state.size = 8;
  });
  byId("hard").addEventListener("click", ()=>{
    byId("hard").classList.add("active"); byId("easy").classList.remove("active");
    state.size = 12;
  });

  // Start/Next/Reset/Shuffle/Hint
  byId("startBtn").addEventListener("click", startGame);
  byId("nextBtn").addEventListener("click", startRound);
  byId("resetBtn").addEventListener("click", ()=>{ localStorage.removeItem("nounBest"); state.best=0; updateHUD(); });
  byId("shuffleBtn").addEventListener("click", ()=>{
    const pool = byId("pool");
    const tiles = Array.from(pool.querySelectorAll(".tile"));
    for(let i=tiles.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      pool.insertBefore(tiles[j], tiles[i]);
      const tmp = tiles[i]; tiles[i] = tiles[j]; tiles[j] = tmp;
    }
  });
  byId("hintBtn").addEventListener("click", ()=>{
    const fb = byId("feedback");
    fb.style.display="block"; fb.className="feedback";
    fb.innerHTML = `ðŸ”Ž <b>Hint:</b> 
      <ul style="margin:6px 0 0 18px">
        <li><b>Entall</b>: Ã©n/ett. <b>Flertall</b>: flere.</li>
        <li><b>Ubestemt</b>: en/ei/et + ordet (eller flertall uten -ene). <b>Bestemt</b>: endelse som <i>-en/-a/-et/-ene</i>.</li>
        <li><b>Egennavn</b> skrives med stor forbokstav (Oslo, Norge, Ahmed).</li>
        <li><b>KjÃ¸nn</b>: enâ€‘, eiâ€‘, etâ€‘ord (her bruker vi skolebÃ¸yning â€“ noen sier ogsÃ¥ Â«en bokÂ»).</li>
      </ul>`;
  });

  // Modal
  byId("addWordBtn").addEventListener("click", openModal);
  byId("mCancel").addEventListener("click", closeModal);
  byId("mSave").addEventListener("click", saveWordFromModal);
  byId("mBase").addEventListener("input", suggestForms);
  byId("mGender").addEventListener("change", suggestForms);
  Array.from(byId("mThemes").querySelectorAll(".tag")).forEach(tag=>{
    tag.addEventListener("click", ()=> tag.classList.toggle("active"));
  });

  setMode(state.mode);
  updateHUD();
});
</script>
</body>
</html>
